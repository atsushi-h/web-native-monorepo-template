<!--
Based on ai-coding-project-boilerplate by Shinsuke Kagawa
https://github.com/shinpr/ai-coding-project-boilerplate
-->

# 技術設計ルール

このルールファイルは、プロジェクトの技術的なアーキテクチャ設計、データフロー設計、環境設定に関するルールとガイドラインを定義します。

## 環境変数管理とセキュリティ

### 環境変数管理
- 環境変数は一元管理し、型安全性を確保する仕組みを構築すること
- `process.env` の直接参照は避け、設定管理層を通じて取得すること
- デフォルト値の設定や必須チェックを適切に実装すること

### セキュリティ
- `.env`ファイルはGitに含めない
- APIキーやシークレットは必ず環境変数として管理
- 機密情報のログ出力は禁止
- エラーメッセージに機密情報を含めない

## 設計ドキュメントとプロセス

### PRD/ADR/Design Doc/作業計画書作成プロセス

#### 作成が必要なケース

以下の規模判定基準に従って、必要なドキュメント作成を判断します：

| 規模 | ファイル数 | PRD | ADR | Design Doc | 作業計画書 |
|------|-----------|-----|-----|------------|----------|
| 小規模 | 1-2 | 不要 | 不要 | 不要 | 簡易版 |
| 中規模 | 3-5 | 不要 | 条件付き※1 | **必須** | **必須** |
| 大規模 | 6以上 | 条件付き※2 | 条件付き※1 | **必須** | **必須** |

※1: アーキテクチャ変更、新技術導入、データフロー変更がある場合
※2: 新機能追加の場合

#### 実装フロー
1. **新機能追加時**: requirement-analyzer → PRD（大規模の場合） → ADR（条件付き） → Design Doc → 作業計画書 → 実装
2. **大規模変更時（6ファイル以上）**: requirement-analyzer → ADR（条件付き） → Design Doc → 作業計画書 → 実装
3. **中規模変更時（3-5ファイル）**: requirement-analyzer → Design Doc → 作業計画書 → 実装
4. **小規模修正時（1-2ファイル）**: 簡易計画書 → 直接実装

#### 作業計画書について
- **保存場所**: `docs/plans/`（.gitignoreで除外）
- **命名規則**: `PLAN-NNNN-YYYYMMDD-{type}-{title}.md`
  例: `PLAN-0001-20250103-feature-user-authentication.md`
- **テンプレート**: `docs/plans/template.md`
- **運用フロー**: 
  1. 中規模以上の変更開始時に作成
  2. 各フェーズ完了時に進捗更新（チェックボックス）
  3. 全タスク完了後、ユーザー承認を得て削除

#### ADR（Architecture Decision Record）
重要な技術的決定を記録し、将来の実装者が意思決定の背景を理解できるようにする。

#### サブエージェント連携
上記のプロセスはサブエージェントと連携して実行されます。詳細なオーケストレーションフローは`docs/rules/sub-agents.md`を参照してください。

### データフロー統一原則

#### 基本原則
1. **単一データソース**: 同じ情報は1箇所にのみ保存する
2. **構造化データ優先**: JSON文字列ではなくパース済みオブジェクトを使用
3. **明確な責務分離**: 各層の責務を明確に定義

#### データフローのベストプラクティス
- **入力時点での検証**: データは入力層で検証し、型安全な形で内部に渡す
- **変換の一元化**: データ変換ロジックは専用のユーティリティに集約
- **ログの構造化**: データフローの各段階で構造化ログを出力

## ビルドとテスト

プロジェクトごとにビルドコマンドとテスト実行方法を定義。

## 参照した手法・原則
- **ADR（Architecture Decision Record）**: Michael Nygard「Documenting Architecture Decisions」
- **単一データソース原則**: Single Source of Truth（データ管理のベストプラクティス）
- **依存性注入（DI）**: Martin Fowler「Inversion of Control Containers and the Dependency Injection pattern」
品質チェックは実装完了時に必須。